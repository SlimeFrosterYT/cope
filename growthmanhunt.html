<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Growth Manhunt</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #0d0d0d;
        }
        canvas {
            display: block;
        }
    </style>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
</head>
<body>
    <canvas id="gameCanvas"></canvas>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        const keys = {
            w: false,
            a: false,
            s: false,
            d: false
        };

        const mouse = {
            x: canvas.width / 2,
            y: canvas.height / 2
        };

        let isMouseDown = false;
        let lastShotTime = 0;
        const cooldown = 500; // 0.5 seconds in milliseconds

        const socket = io("https://copemai.onrender.com");
        let myId;
        let players = {};
        let bullets = {};

        // --- Camera and Static World Objects ---
        const camera = { x: 0, y: 0 };
        const wall = {
            x: 200, 
            y: 200, 
            width: 200,
            height: 200,
            strokeStyle: '#ffffff',
            lineWidth: 2
        };

        function drawWall() {
            ctx.strokeStyle = wall.strokeStyle;
            ctx.lineWidth = wall.lineWidth;
            ctx.strokeRect(wall.x - camera.x, wall.y - camera.y, wall.width, wall.height);
        }
        // --- End Camera and Static World Objects ---

        // Listeners for server events
        socket.on('connect', () => {
            console.log('Connected to server with ID:', socket.id);
        });

        socket.on('init', (data) => {
            myId = data.playerId;
            players = data.players;
            bullets = data.bullets;
        });

        socket.on('playerConnected', (newPlayer) => {
            players[newPlayer.id] = newPlayer;
        });

        socket.on('updatePlayers', (serverPlayers) => {
            players = serverPlayers;
        });

        socket.on('playerDisconnected', (playerId) => {
            delete players[playerId];
        });

        socket.on('newBullet', (bulletData) => {
            bullets[bulletData.id] = bulletData;
        });

        socket.on('updateBullets', (serverBullets) => {
            bullets = serverBullets;
        });

        // The drawing functions now use the camera offset
        function drawPlayer(player) {
            const angle = player.barrelAngle;
            const screenX = player.x - camera.x;
            const screenY = player.y - camera.y;

            ctx.fillStyle = player.color;
            ctx.beginPath();
            ctx.arc(screenX, screenY, player.radius, 0, Math.PI * 2);
            ctx.fill();

            ctx.save();
            ctx.translate(screenX, screenY);
            ctx.rotate(angle);

            ctx.fillStyle = '#cccccc';
            ctx.fillRect(player.radius - 2, -20 / 2, 20, 20);
            ctx.restore();
        }

        function drawBullet(bullet) {
            const screenX = bullet.x - camera.x;
            const screenY = bullet.y - camera.y;
            ctx.fillStyle = '#ffffff';
            ctx.beginPath();
            ctx.arc(screenX, screenY, bullet.radius, 0, Math.PI * 2);
            ctx.fill();
        }

        function gameLoop() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const myPlayer = players[myId];
            if (myPlayer) {
                // Update the camera to center on the local player
                camera.x = myPlayer.x - canvas.width / 2;
                camera.y = myPlayer.y - canvas.height / 2;

                // Handle player movement based on local key presses
                let vx = 0;
                let vy = 0;
                const speed = 4.5;
                
                if (keys.w) vy -= speed;
                if (keys.s) vy += speed;
                if (keys.a) vx -= speed;
                if (keys.d) vx += speed;

                myPlayer.x += vx;
                myPlayer.y += vy;
                
                // Update barrel angle based on mouse position
                myPlayer.barrelAngle = Math.atan2(mouse.y - canvas.height / 2, mouse.x - canvas.width / 2);

                // Send the updated state to the server
                socket.emit('playerMove', { 
                    x: myPlayer.x, 
                    y: myPlayer.y, 
                    barrelAngle: myPlayer.barrelAngle 
                });
                
                // Handle shooting
                if (isMouseDown && Date.now() - lastShotTime > cooldown) {
                    lastShotTime = Date.now();
                    const angle = myPlayer.barrelAngle;
                    const bulletStartX = myPlayer.x + Math.cos(angle) * (myPlayer.radius + 20);
                    const bulletStartY = myPlayer.y + Math.sin(angle) * (myPlayer.radius + 20);
                    
                    socket.emit('playerShoot', { 
                        x: bulletStartX, 
                        y: bulletStartY,
                        velocity: {
                            x: Math.cos(angle) * 10,
                            y: Math.sin(angle) * 10
                        }
                    });
                }
            }

            // Draw the wall first
            drawWall();

            // Draw all players based on the state received from the server
            for (const id in players) {
                drawPlayer(players[id]);
            }
            
            // Draw all bullets based on the state received from the server
            for (const id in bullets) {
                drawBullet(bullets[id]);
            }
            
            requestAnimationFrame(gameLoop);
        }

        // Handle keyboard input
        window.addEventListener('keydown', (e) => {
            if (e.key === 'w') keys.w = true;
            if (e.key === 'a') keys.a = true;
            if (e.key === 's') keys.s = true;
            if (e.key === 'd') keys.d = true;
        });

        window.addEventListener('keyup', (e) => {
            if (e.key === 'w') keys.w = false;
            if (e.key === 'a') keys.a = false;
            if (e.key === 's') keys.s = false;
            if (e.key === 'd') keys.d = false;
        });

        // Handle mouse movement to track the cursor position
        window.addEventListener('mousemove', (e) => {
            mouse.x = e.clientX;
            mouse.y = e.clientY;
        });

        // Handle mouse click to shoot continuously
        window.addEventListener('mousedown', () => {
            isMouseDown = true;
        });

        window.addEventListener('mouseup', () => {
            isMouseDown = false;
        });

        gameLoop();
    </script>
</body>
</html>
