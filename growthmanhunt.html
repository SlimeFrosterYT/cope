<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Growth Manhunt - Phaser</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #010409; }
        canvas { display: block; }
        .chat-container {
            position: absolute; bottom: 10px; left: 10px; width: 300px;
            background-color: rgba(0,0,0,0.5); padding: 10px; border-radius: 5px;
        }
        .chat-input {
            width: 100%; background: none; border: 1px solid #555; color: white;
            padding: 5px; box-sizing: border-box; outline: none;
        }
        #score-display {
            position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%);
            font-size: 1.5em; color: white; background-color: rgba(0,0,0,0.5);
            padding: 5px 10px; border-radius: 5px; z-index: 10;
        }
    </style>
</head>
<body>
    <div id="score-display">Score: 0</div>
    <div class="chat-container">
        <input type="text" class="chat-input" placeholder="Press Enter to chat..." id="chatInput">
    </div>

    <!-- Phaser CDN -->
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>

    <script>
    const socket = io();
    const chatInput = document.getElementById('chatInput');
    const scoreDisplay = document.getElementById('score-display');

    let playerId = null;
    let players = {};
    let bullets = {};
    const keys = { w:false, a:false, s:false, d:false };
    let mouse = { x: 0, y: 0 };
    let shooting = false;

    // --- PHASER SETUP ---
    class MainScene extends Phaser.Scene {
        constructor() { super({ key: 'MainScene' }); }

        preload() {
            // nothing to preload, we draw graphics
        }

        create() {
            this.playerObjects = {};

            this.input.on('pointermove', (pointer) => {
                mouse.x = pointer.x;
                mouse.y = pointer.y;
            });
            this.input.on('pointerdown', () => shooting = true);
            this.input.on('pointerup', () => shooting = false);

            socket.on('init', (data) => {
                playerId = data.playerId;
                players = data.players;

                // Spawn Phaser objects for each player
                for (const id in players) {
                    const p = players[id];
                    this.addPlayer(id, p.x, p.y);
                }
            });

            socket.on('updatePlayers', (serverPlayers) => {
                players = serverPlayers;

                // Update positions
                for (const id in serverPlayers) {
                    const p = serverPlayers[id];
                    if (!this.playerObjects[id]) this.addPlayer(id, p.x, p.y);
                    const obj = this.playerObjects[id];
                    obj.x = p.x;
                    obj.y = p.y;
                    obj.rotation = p.barrelAngle || 0;
                }

                if (players[playerId]) {
                    scoreDisplay.textContent = `Score: ${Math.floor(players[playerId].score)}`;
                }
            });

            socket.on('updateBullets', (serverBullets) => {
                bullets = serverBullets;
                // optional: render bullets in Phaser
            });
        }

        addPlayer(id, x, y) {
            const g = this.add.graphics();
            g.fillStyle(0xffffff, 1); // white
            g.lineStyle(4, 0x000000, 1); // black outline
            g.fillCircle(0, 0, 50);
            g.strokeCircle(0, 0, 50);
            g.x = x;
            g.y = y;
            this.playerObjects[id] = g;
        }

        update(time, delta) {
            // Emit player input
            if (playerId && players[playerId]) {
                if (!chatInput.matches(':focus')) {
                    // Barrel angle
                    const dx = mouse.x - players[playerId].x;
                    const dy = mouse.y - players[playerId].y;
                    const angle = Math.atan2(dy, dx);
                    socket.emit('playerAim', { barrelAngle: angle });

                    if (shooting) socket.emit('playerShoot', { damage: 0.25 });
                }

                socket.emit('playerInput', keys);
            }
        }
    }

    const config = {
        type: Phaser.AUTO,
        width: window.innerWidth,
        height: window.innerHeight,
        backgroundColor: '#010409',
        parent: null,
        scene: [MainScene]
    };

    const game = new Phaser.Game(config);

    // --- INPUT HANDLERS ---
    document.addEventListener('keydown', (e) => {
        if (e.key === 'w') keys.w = true;
        if (e.key === 'a') keys.a = true;
        if (e.key === 's') keys.s = true;
        if (e.key === 'd') keys.d = true;

        if (e.key === 'Enter' || e.key === 't') chatInput.focus();
    });
    document.addEventListener('keyup', (e) => {
        if (e.key === 'w') keys.w = false;
        if (e.key === 'a') keys.a = false;
        if (e.key === 's') keys.s = false;
        if (e.key === 'd') keys.d = false;
    });

    // --- USERNAME PROMPT ---
    const urlParams = new URLSearchParams(window.location.search);
    const username = urlParams.get('username') || prompt("Enter username:");
    socket.emit('setUsername', username);

    </script>
</body>
</html>
