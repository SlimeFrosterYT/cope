<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Growth Manhunt</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #0d0d0d;
            font-family: sans-serif;
            color: white;
        }
        canvas {
            display: block;
        }
        #chat-container {
            position: fixed;
            bottom: 10px;
            left: 10px;
            width: 300px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 5px;
            padding: 10px;
            box-sizing: border-box;
        }
        #chat-messages {
            height: 150px;
            overflow-y: auto;
            margin-bottom: 10px;
            font-size: 14px;
        }
        #chat-input {
            width: 100%;
            padding: 5px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            box-sizing: border-box;
        }
    </style>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
</head>
<body>
    <canvas id="gameCanvas"></canvas>
    
    <div id="chat-container">
        <div id="chat-messages"></div>
        <input type="text" id="chat-input" placeholder="Press Enter to chat..." />
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const chatInput = document.getElementById('chat-input');
        const chatMessages = document.getElementById('chat-messages');

        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        const keys = {
            w: false,
            a: false,
            s: false,
            d: false
        };

        const mouse = {
            x: canvas.width / 2,
            y: canvas.height / 2
        };

        let isMouseDown = false;
        let lastShotTime = 0;
        const cooldown = 500;
        const FADE_DURATION = 1000;

        const socket = io("https://copemai.onrender.com");
        let myId;
        let players = {};
        let playersLastState = {};
        let bullets = {};
        let lastUpdateTime = Date.now();
        let chatIsFocused = false;

        const camera = { x: 0, y: 0 };
        let wall;

        function drawWall() {
            if (!wall) return;
            ctx.strokeStyle = '#ffffff';
            ctx.lineWidth = 2;
            ctx.strokeRect(wall.x - camera.x, wall.y - camera.y, wall.width, wall.height);
        }

        function drawPlayer(player) {
            let playerToDraw = player;
            if (player.id !== myId && playersLastState[player.id]) {
                const now = Date.now();
                const latency = now - lastUpdateTime;
                const interpolationFactor = Math.min(1, latency / 100);

                const lastPos = playersLastState[player.id];
                const currentPos = player;

                const interpolatedX = lastPos.x + (currentPos.x - lastPos.x) * interpolationFactor;
                const interpolatedY = lastPos.y + (currentPos.y - lastPos.y) * interpolationFactor;

                playerToDraw = { ...player, x: interpolatedX, y: interpolatedY };
            }
            
            const angle = playerToDraw.barrelAngle;
            const screenX = playerToDraw.x - camera.x;
            const screenY = playerToDraw.y - camera.y;

            ctx.fillStyle = playerToDraw.color;
            ctx.beginPath();
            ctx.arc(screenX, screenY, playerToDraw.radius, 0, Math.PI * 2);
            ctx.fill();

            ctx.save();
            ctx.translate(screenX, screenY);
            ctx.rotate(angle);

            ctx.fillStyle = '#cccccc';
            ctx.fillRect(playerToDraw.radius - 2, -20 / 2, 20, 20);
            ctx.restore();
        }

        function drawBullet(bullet) {
            const now = Date.now();
            let opacity = 1;
            if (bullet.isFading) {
                const elapsedTime = now - bullet.fadeStartTime;
                opacity = 1 - (elapsedTime / FADE_DURATION);
                if (opacity < 0) opacity = 0;
            }

            const screenX = bullet.x - camera.x;
            const screenY = bullet.y - camera.y;
            
            ctx.globalAlpha = opacity;
            ctx.fillStyle = '#ffffff';
            ctx.beginPath();
            ctx.arc(screenX, screenY, bullet.radius, 0, Math.PI * 2);
            ctx.fill();
            ctx.globalAlpha = 1;
        }

        function addMessageToChat(message) {
            const p = document.createElement('p');
            p.textContent = message;
            chatMessages.appendChild(p);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        socket.on('init', (data) => {
            myId = data.playerId;
            players = data.players;
            playersLastState = JSON.parse(JSON.stringify(data.players));
            bullets = data.bullets;
            wall = data.wall;
        });

        socket.on('playerConnected', (newPlayer) => {
            players[newPlayer.id] = newPlayer;
            playersLastState[newPlayer.id] = newPlayer;
        });

        socket.on('updatePlayers', (serverPlayers) => {
            playersLastState = JSON.parse(JSON.stringify(players));
            players = serverPlayers;
            lastUpdateTime = Date.now();
        });

        socket.on('playerDisconnected', (playerId) => {
            delete players[playerId];
            delete playersLastState[playerId];
        });

        socket.on('newBullet', (bulletData) => {
            bullets[bulletData.id] = bulletData;
        });

        socket.on('updateBullets', (serverBullets) => {
            bullets = serverBullets;
        });

        socket.on('chatMessage', (message) => {
            addMessageToChat(message);
        });

        function gameLoop() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const myPlayer = players[myId];
            if (myPlayer) {
                camera.x = myPlayer.x - canvas.width / 2;
                camera.y = myPlayer.y - canvas.height / 2;

                socket.emit('playerInput', keys);
                
                myPlayer.barrelAngle = Math.atan2(mouse.y - canvas.height / 2, mouse.x - canvas.width / 2);

                socket.emit('playerAim', { barrelAngle: myPlayer.barrelAngle });
                
                if (isMouseDown && Date.now() - lastShotTime > cooldown) {
                    lastShotTime = Date.now();
                    const angle = myPlayer.barrelAngle;
                    const bulletStartX = myPlayer.x + Math.cos(angle) * (myPlayer.radius + 20);
                    const bulletStartY = myPlayer.y + Math.sin(angle) * (myPlayer.radius + 20);
                    
                    socket.emit('playerShoot', { 
                        x: bulletStartX, 
                        y: bulletStartY,
                        velocity: {
                            x: Math.cos(angle) * 10,
                            y: Math.sin(angle) * 10
                        }
                    });
                }
            }

            drawWall();

            for (const id in players) {
                drawPlayer(players[id]);
            }
            
            for (const id in bullets) {
                drawBullet(bullets[id]);
            }
            
            requestAnimationFrame(gameLoop);
        }

        window.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                if (chatIsFocused) {
                    const message = chatInput.value.trim();
                    if (message) {
                        socket.emit('chatMessage', message);
                        chatInput.value = '';
                    }
                    chatInput.blur();
                    chatIsFocused = false;
                } else {
                    chatInput.focus();
                    chatIsFocused = true;
                }
            }
            if (chatIsFocused) return;
            if (e.key === 'w') keys.w = true;
            if (e.key === 'a') keys.a = true;
            if (e.key === 's') keys.s = true;
            if (e.key === 'd') keys.d = true;
        });

        window.addEventListener('keyup', (e) => {
            if (e.key === 'w') keys.w = false;
            if (e.key === 'a') keys.a = false;
            if (e.key === 's') keys.s = false;
            if (e.key === 'd') keys.d = false;
        });

        window.addEventListener('mousemove', (e) => {
            mouse.x = e.clientX;
            mouse.y = e.clientY;
        });

        window.addEventListener('mousedown', () => {
            if (!chatIsFocused) isMouseDown = true;
        });

        window.addEventListener('mouseup', () => {
            isMouseDown = false;
        });

        chatInput.addEventListener('focus', () => {
            chatIsFocused = true;
        });

        chatInput.addEventListener('blur', () => {
            chatIsFocused = false;
        });

        gameLoop();
    </script>
</body>
</html>
