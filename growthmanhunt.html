<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Growth Manhunt</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #010409;
        }
        canvas {
            display: block;
            width: 100vw;
            height: 100vh;
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const socket = io();

        let playerId = null;
        let players = {};
        let bullets = {};
        let cubes = {};
        let pentagons = {};
        let triangles = {};
        let wall = {};
        let mapSize = {};

        const keys = { w: false, a: false, s: false, d: false };
        let mouse = { x: 0, y: 0 };
        let playerBarrelAngle = 0;
        let shooting = false;

        let camera = { x: 0, y: 0 };
        
        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            if (playerId && players[playerId]) {
                const player = players[playerId];
                camera.x = player.x - canvas.width / 2;
                camera.y = player.y - canvas.height / 2;
            }
        });
        window.dispatchEvent(new Event('resize'));

        // A very basic username prompt for joining the game
        const username = prompt("Enter your username:");
        if (username) {
            socket.emit('setUsername', username);
        } else {
            alert("Username is required to join the game.");
        }


        socket.on('init', (data) => {
            playerId = data.playerId;
            players = data.players;
            bullets = data.bullets;
            cubes = data.cubes;
            pentagons = data.pentagons;
            triangles = data.triangles;
            wall = data.wall;
            mapSize = data.mapSize;

            if (players[playerId]) {
                camera.x = players[playerId].x - canvas.width / 2;
                camera.y = players[playerId].y - canvas.height / 2;
            }
        });

        socket.on('updatePlayers', (serverPlayers) => {
            players = serverPlayers;
        });

        socket.on('updateBullets', (serverBullets) => {
            bullets = serverBullets;
        });

        socket.on('updateCubes', (serverCubes) => {
            cubes = serverCubes;
        });

        socket.on('updatePentagons', (serverPentagons) => {
            pentagons = serverPentagons;
        });

        socket.on('updateTriangles', (serverTriangles) => {
            triangles = serverTriangles;
        });
        
        socket.on('kill', () => {
            window.alert('You were killed!');
            // Re-prompt for username to re-join
            const newUsername = prompt("You were killed! Enter your username to re-join:");
            if (newUsername) {
                socket.emit('setUsername', newUsername);
            }
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'w') keys.w = true;
            if (e.key === 'a') keys.a = true;
            if (e.key === 's') keys.s = true;
            if (e.key === 'd') keys.d = true;
        });

        document.addEventListener('keyup', (e) => {
            if (e.key === 'w') keys.w = false;
            if (e.key === 'a') keys.a = false;
            if (e.key === 's') keys.s = false;
            if (e.key === 'd') keys.d = false;
        });

        canvas.addEventListener('mousemove', (e) => {
            mouse.x = e.clientX;
            mouse.y = e.clientY;
        });

        canvas.addEventListener('mousedown', (e) => {
            if (e.button === 0) {
                shooting = true;
            }
        });

        canvas.addEventListener('mouseup', (e) => {
            if (e.button === 0) {
                shooting = false;
            }
        });

        function drawPlayer(player) {
            ctx.fillStyle = player.color;
            ctx.beginPath();
            ctx.arc(player.x - camera.x, player.y - camera.y, player.radius, 0, Math.PI * 2);
            ctx.fill();
            ctx.closePath();
        }

        function drawBullet(bullet) {
            ctx.fillStyle = 'white';
            ctx.beginPath();
            ctx.arc(bullet.x - camera.x, bullet.y - camera.y, bullet.radius, 0, Math.PI * 2);
            ctx.fill();
            ctx.closePath();
        }

        function drawCube(cube) {
            ctx.fillStyle = '#ffde59';
            ctx.beginPath();
            ctx.rect(cube.x - camera.x, cube.y - camera.y, cube.size, cube.size);
            ctx.fill();
            ctx.closePath();
        }

        function drawPentagon(pentagon) {
            ctx.fillStyle = '#800080';
            ctx.beginPath();
            const sides = 5;
            const size = pentagon.size / 2;
            ctx.moveTo(pentagon.x - camera.x + size * Math.cos(0), pentagon.y - camera.y + size * Math.sin(0));
            for (let i = 1; i <= sides; i++) {
                ctx.lineTo(pentagon.x - camera.x + size * Math.cos(i * 2 * Math.PI / sides), pentagon.y - camera.y + size * Math.sin(i * 2 * Math.PI / sides));
            }
            ctx.fill();
            ctx.closePath();
        }

        function drawTriangle(triangle) {
            ctx.fillStyle = '#ff4d4d';
            ctx.beginPath();
            const sides = 3;
            const size = triangle.size / 2;
            ctx.moveTo(triangle.x - camera.x + size * Math.cos(0), triangle.y - camera.y + size * Math.sin(0));
            for (let i = 1; i <= sides; i++) {
                ctx.lineTo(triangle.x - camera.x + size * Math.cos(i * 2 * Math.PI / sides), triangle.y - camera.y + size * Math.sin(i * 2 * Math.PI / sides));
            }
            ctx.fill();
            ctx.closePath();
        }

        function drawMap() {
            ctx.strokeStyle = '#555';
            ctx.lineWidth = 5;
            ctx.beginPath();
            ctx.rect(0 - camera.x, 0 - camera.y, mapSize.width, mapSize.height);
            ctx.stroke();
            ctx.closePath();
        }

        function animate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (playerId && players[playerId]) {
                const player = players[playerId];
                const lerpFactor = 0.1;
                camera.x += (player.x - canvas.width / 2 - camera.x) * lerpFactor;
                camera.y += (player.y - canvas.height / 2 - camera.y) * lerpFactor;
            }

            drawMap();
            Object.values(cubes).forEach(drawCube);
            Object.values(pentagons).forEach(drawPentagon);
            Object.values(triangles).forEach(drawTriangle);
            Object.values(players).forEach(drawPlayer);
            Object.values(bullets).forEach(drawBullet);
            

            if (playerId && players[playerId]) {
                const player = players[playerId];
                const dx = mouse.x - (player.x - camera.x);
                const dy = mouse.y - (player.y - camera.y);
                const newBarrelAngle = Math.atan2(dy, dx);
                if (newBarrelAngle !== playerBarrelAngle) {
                    playerBarrelAngle = newBarrelAngle;
                    socket.emit('playerAim', { barrelAngle: playerBarrelAngle });
                }

                if (shooting) {
                    const bulletStrength = 10;
                    const bulletSpeed = 10;
                    const bulletVelocity = {
                        x: Math.cos(player.barrelAngle) * bulletSpeed,
                        y: Math.sin(player.barrelAngle) * bulletSpeed
                    };
                    const bulletSpawnX = player.x + Math.cos(player.barrelAngle) * (player.radius + player.bulletRadius);
                    const bulletSpawnY = player.y + Math.sin(player.barrelAngle) * (player.radius + player.bulletRadius);

                    socket.emit('playerShoot', {
                        x: bulletSpawnX,
                        y: bulletSpawnY,
                        velocity: bulletVelocity,
                        strength: bulletStrength
                    });
                }
            }
            
            if (playerId) {
                socket.emit('playerInput', keys);
            }

            requestAnimationFrame(animate);
        }

        animate();
    </script>
</body>
</html>
